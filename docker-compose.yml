version: '2'
services:
    app:
        build:
            context: .
            args:
                USER_ID: $USER_ID
        depends_on:
            - psql
            - mailhog
            - selenium
        volumes:
            - ".:/app"
            - "./tasks/files/php.ini:/etc/php5/cli/php.ini"
            - "./tasks/files/php.ini:/etc/php5/fpm/php.ini"
            - "./tasks/files/php-fpm.conf:/etc/php5/fpm/php-fpm.conf"
            - "~/.composer:/home/tg/.composer"
        command: /usr/sbin/php5-fpm
        environment:
            USE_POLLING_WATCHES: 1
            PGHOST: psql
            SYMFONY_OKOA_CACHE_DIR: /tmp/symfony/cache
            SYMFONY_OKOA_LOG_DIR: /tmp/symfony/logs
        networks:
            - default

    nginx:
        image: nginx:latest
        depends_on:
            - app
        volumes:
            - ".:/app"
            - "./tasks/files/nginx.dev.conf:/etc/nginx/conf.d/dev.conf"
            - "./tasks/files/nginx.prod.conf:/etc/nginx/conf.d/prod.conf"
        ports:
            - "80:80"
            - "8080:8080"
        networks:
            default:
                aliases:
                    - web.dev
                    - app.dev
                    - admin.dev

    psql:
        image: postgres:9.4
        environment:
            POSTGRES_USER: tg
        ports:
            - "5432:5432"
        networks:
            - default

    mailhog:
        image: mailhog/mailhog:latest
        environment:
            MH_API_BIND_ADDR: 0.0.0.0:1080
            MH_UI_BIND_ADDR: 0.0.0.0:1080
            MH_SMTP_BIND_ADDR: 0.0.0.0:1025
        ports:
            - "1080:1080"
        networks:
            - default

    selenium:
        image: selenium/hub
        ports:
            - "4444:4444"
        networks:
            - default

    chrome:
        image: selenium/node-chrome-debug
        # See: https://github.com/SeleniumHQ/docker-selenium/issues/91
        environment:
             HUB_PORT_4444_TCP_ADDR: selenium
             no_proxy: "*.local,169.254/16"
        depends_on:
            - selenium
            - app
        ports:
            - "15900:5900"
        networks:
            - default

    firefox:
        image: selenium/node-firefox-debug
        # See: https://github.com/SeleniumHQ/docker-selenium/issues/91
        environment:
            HUB_PORT_4444_TCP_ADDR: selenium
            no_proxy: "*.local,169.254/16"
        depends_on:
            - selenium
            - app
        ports:
            - "15901:5900"
        networks:
            - default
networks:
    default: ~
